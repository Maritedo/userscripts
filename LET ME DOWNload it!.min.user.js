// ==UserScript==
// @name         LET ME DOWNload it!
// @namespace    https://userjs.justtryit.top/
// @version      0.1.0
// @description
// @author       blairollie63@gmail.com
// @match        https://*.ai-augmented.com/*
// @grant        window.onurlchange
// @run-at       document-body
// @updateURL    https://userjs.justtryit.top/LET%20ME%20DOWNload%20it!.min.user.js
// @downloadURL  https://userjs.justtryit.top/LET%20ME%20DOWNload%20it!.min.user.js
// @installURL   https://userjs.justtryit.top/LET%20ME%20DOWNload%20it!.min.user.js
// @supportURL   https://userjs.justtryit.top/
// ==/UserScript==

!function () { "use strict"; const e = !0, n = window.console.log; function t(...t) { e && n("[LMDI]", ...t) } window.console.log = (() => null), window.console.info = (() => null), window.console.warn = (() => null), window.console.error = (() => null); let o, i, l, r = "", c = "", d = !1, a = { def: "#ffad1698", blk: "#3339" }; function u() { if (!d) return alert("未找到资源"); var e; t(`尝试下载${r}: ${c}`), e = r, fetch(c).then(async e => { let n = await e.blob(); return n }).then(n => { const t = URL.createObjectURL(n), o = document.createElement("a"); o.href = t, o.download = e, o.target = "_blank", o.click(), URL.revokeObjectURL(t) }) } t("插件已运行"); const s = { empty: () => { d = !1, o.style.backgroundColor = a.blk }, okay: () => { d = !0, o.style.backgroundColor = a.def, l(c, r), t("found", r, "at", c) } }; function f() { p("iframe", e => { t("找到iframe"); const n = document.querySelector("div.node-item div.node-selected div.node-inner"); if (n && e.src) { t("更新成功"); let o = e.src; c = o.slice(o.indexOf("furl") + 5), r = n.textContent, s.okay() } else t("更新失败"), s.empty() }).on(".ta-frame") } function p(e, n = null) { const o = [], i = []; let l, r; function c(e, n = null) { r = n, function e(n, c, d) { t("observing", c, "on", n); const a = new Promise(d => { const a = n => { let t; d(), l = n, (t = i.shift()) ? e(n, t, o.shift()) : r && setTimeout(e => r()) }; let u; null !== (u = n.querySelector(c)) ? (t("DIRECT find", c, "inside", n), a(u)) : (t("SPYING element", c, "inside", n), t("Previous attempt failure", u), (u = new MutationObserver(e => { e.find(e => Array.from(e.addedNodes).find(e => ((e.matches && e.matches(c) || e.querySelector && (e = e.querySelector(c))) && (u.disconnect(), a(e)), !1))) })).observe(n, { childList: !0, subtree: !0 })) }); d && a.then(() => d(l)) }(document, e, null) } return function e(n, t = null) { return i.push(n), o.push(t), { then: e, on: c } }(e, n) } function h(e, n = null) { const t = document.createElement(e); if ("object" != typeof n) throw new Error("参数非合法对象属性选项"); if (n) for (const e in n) "object" == typeof n[e] && null !== n[e] ? Object.assign(t[e], n[e]) : t[e] = n[e]; function o() { return t } function i() { return document.body.appendChild(t), t } function l(e, n) { return t.addEventListener(e, n), { child: c, append: i, modify: r, final: o, listen: l } } function r(e) { return e(t), { child: c, append: i, modify: r, final: o, listen: l } } function c(e) { return e instanceof HTMLElement ? t.appendChild(e) : t.appendChild(e.final()), { child: c, append: i, modify: r, final: o, listen: l } } return { child: c, append: i, modify: r, final: o, listen: l } } p("#root", () => { t("注入按钮完成"), o = h("label", { style: { cursor: "pointer", textDecoration: "none", userSelect: "none", "-webkit-user-select": "none", boxShadow: "0 -3px 8px -8px rgba(0, 0, 0, 0.1), 0 5px 6px 0 rgba(0, 0, 0, 0.1), 0 -8px 18px 5px rgba(0, 0, 0, 0.05)", position: "fixed", bottom: "48px", right: "48px", borderRadius: "24px", width: "48px", height: "48px", backgroundColor: a.blk, backdropFilter: "blur(3px)", "-webkit-backdrop-filter": "blur(3px)", transiton: "all .2s ease" } }).child(i = h("a", { textContent: "下载", style: { display: "inline-block", color: "#000", lineHeight: "48px", width: "100%", textAlign: "center" } }).listen("click", e => { e.preventDefault(), u() }).final()).append(), l = ((e, n) => { i.title = n, i.href = e }) }).then("#xy_app_content", () => { t("监测到小雅主体加载完成") }).then("div.ta_panel.ta_panel_group.ta_group", () => { t("监测到课程页面加载完成") }).on("body", () => { t("页面载入完成"), !function (e, ...n) { let t, o = e; for (; t = n.shift();) { if (!o[t]) return !1; o = o[t] } return !0 }(window, "unsafeWindow", "$history", "listen") ? t("未能将监听器注入到路由,仅当手动刷新页面时可以正常刷新下载") : (t("成功在路由中注入监听器"), window.unsafeWindow.$history.listen((e, n) => { f() })), f() }) }();