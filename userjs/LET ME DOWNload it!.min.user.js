// ==UserScript==
// @name         LET ME DOWNload it!
// @namespace    https://userjs.justtryit.top/#home
// @version      0.1.2
// @description
// @author       blairollie63@gmail.com
// @match        *://*.ai-augmented.com/*
// @run-at       document-start
// @grant        GM_download
// @updateURL    https://userjs.justtryit.top/userjs/LET%20ME%20DOWNload%20it!.min.user.js
// @downloadURL  https://userjs.justtryit.top/userjs/LET%20ME%20DOWNload%20it!.min.user.js
// @installURL   https://userjs.justtryit.top/userjs/LET%20ME%20DOWNload%20it!.min.user.js
// @supportURL   https://userjs.justtryit.top/#about
// ==/UserScript==

(function () { "use strict"; const t = !1, e = console.log; function n(...n) { if (!t) return; const o = (new Error).stack.split("\n")[2].trim().split(":"), r = o.length - 2; e(`[LMDI:${o[r]}]`, ...n) } console.log = (() => null), console.info = (() => null), console.warn = (() => null), console.error = (() => null); let o, r, i, s, l, a = "", d = "", u = !1; const c = { def: "#ffad1698", blk: "#3339" }, f = "#3498db"; function p() { var t = 2 * Math.PI * (s.getAttribute("r") || 48); s.style.strokeDashoffset = t, s.style.stroke = "#0000" } n("插件已运行"), w("#root", () => { n("注入按钮完成"), o = v("label", { style: { cursor: "pointer", textDecoration: "none", userSelect: "none", webkitUserSelect: "none", boxShadow: "0 -3px 8px -8px rgba(0, 0, 0, 0.1), 0 5px 6px 0 rgba(0, 0, 0, 0.1), 0 -8px 18px 5px rgba(0, 0, 0, 0.05)", position: "fixed", bottom: "48px", right: "48px", borderRadius: "24px", width: "48px", height: "48px", backgroundColor: c.blk, backdropFilter: "blur(3px)", webkitBackdropFilter: "blur(3px)", transitonProperty: "all", transitonDuration: "1.2s", transitonTimingFunction: "ease" } }).child(v("div", { style: { width: "48px", height: "48px", position: "relative" } }).child(i = v("svg", { xmlns: g.svg, viewBox: "0 0 100 100", width: "48", height: "48", style: { display: "inline-block", width: "48px", height: "48px" } }).child(s = v("path", { xmlns: g.svg, fill: "none", style: { transitonProperty: "stroke-dasharray stroke-dashoffset stroke", transitonDuration: ".2s", transitonTimingFunction: "ease", stroke: "#0000", strokeWidth: "12" }, d: "M50 6 a 44 44 0 0 1 0 88 a 44 44 0 0 1 0 -88" }).final()).final()).child(r = v("a", { textContent: "下载", style: { display: "inline-block", color: "#000", lineHeight: "48px", position: "absolute", width: "100%", textAlign: "center", left: "0", top: "0", webkitUserDrag: "none" } }).listen("click", t => { t.preventDefault(), function () { if (!u) return alert("未找到资源"); var t, e, o; n(`尝试下载${a}: ${d}`), t = d, e = a, x ? n("下载进行中") : (x = !0, o = 2 * Math.PI * (s.getAttribute("r") || 48), s.style.stroke = f, s.style.strokeDasharray = o, s.style.strokeDashoffset = o, GM_download({ url: t, name: e, saveAs: !1, onerror: m.onerror, onload: m.onload, onprogress: m.onprogress, ontimeout: m.ontimeout })) }() }).final())).append(), l = ((t, e) => { r.title = e, r.href = t, r.download = e }) }).then("#xy_app_content", () => { n("监测到小雅主体加载完成") }).then("div.ta_panel.ta_panel_group.ta_group", () => { n("监测到课程页面加载完成") }).on("body", () => { n("页面载入完成"), b(window, "unsafeWindow", "$history", "listen") ? (n("成功在unsafeWindow对象的路由中注入监听器"), window.unsafeWindow.$history.listen(() => { y() })) : b(window, "$history", "listen") ? (n("成功在window对象的路由中注入监听器"), window.$history.listen(() => { y() })) : n("未能将监听器注入到路由,仅当手动刷新页面时可以正常刷新下载"), y() }); const h = { empty: () => { u = !1, o.style.backgroundColor = c.blk }, okay: () => { u = !0, o.style.backgroundColor = c.def, l(d, a), n("found", a, "at", d) } }; function y() { w("iframe", t => { const e = document.querySelector("div.node-item div.node-selected div.node-inner"); if (e && t.src && t.src.indexOf("furl") >= 0) { n("更新成功"); let o = t.src; d = o.slice(o.indexOf("furl") + 5), a = e.textContent, h.okay() } else n("更新失败"), h.empty() }).on(".ta-frame"), w("video", t => { const e = document.querySelector("div.node-item div.node-selected div.node-inner"); if (t) { n("等待视频载入"), new MutationObserver(o => { Array.from(o).find(t => "attributes" == t.type && "src" == t.attributeName) && (n("更新完成"), d = t.src, a = e.textContent, h.okay()) }).observe(t, { attributes: !0 }) } else n("更新失败", t), h.empty() }).on(".ta-frame") } function b(t, ...e) { let n, o = t; for (; n = e.shift();) { if (!o[n]) return !1; o = o[n] } return !0 } function w(t, e = null) { const n = [], o = []; let r, i; function s(t, e = null) { i = e, function t(e, s, l) { const a = new Promise(l => { const a = e => { let s; l(), r = e, (s = o.shift()) ? t(e, s, n.shift()) : i && setTimeout(() => i()) }; let d; null !== (d = e.querySelector(s)) ? a(d) : (d = new MutationObserver(t => { t.find(t => Array.from(t.addedNodes).find(t => ((t.matches && t.matches(s) || t.querySelector && (t = t.querySelector(s))) && (d.disconnect(), a(t)), !1))) })).observe(e, { childList: !0, subtree: !0 }) }); l && a.then(() => l(r)) }(document, t, null) } return function t(e, r = null) { return o.push(e), n.push(r), { then: t, on: s } }(t, e) } const m = { onerror: () => { n("下载错误"), p(), x = !1 }, onload: () => { n("下载完成"), p(), x = !1 }, onprogress: t => { t.lengthComputable && function (t) { var e = 2 * Math.PI * (s.getAttribute("r") || 48), n = e - t * e; s.style.strokeDasharray = e, s.style.strokeDashoffset = n }(t.loaded / t.total) }, ontimeout: () => { n("下载超时"), p(), x = !1 } }; var x = !1; const g = { svg: "http://www.w3.org/2000/svg", math: "http://www.w3.org/1998/Math/MathML" }, k = ["innerHTML", "textContent", "innerText"]; function v(t, e = null) { let o; if (o = e && e.xmlns ? document.createElementNS(e.xmlns, t) : document.createElement(t), "object" != typeof e) throw new Error("参数非合法对象属性选项"); if (e) for (const t in e) "xmlns" !== t.toLowerCase() && ("object" == typeof e[t] && null !== e[t] ? Object.assign(o[t], e[t]) : k.includes(t) ? o[t] = e[t] : o.setAttribute(t, e[t])); const r = { child: function (t) { t instanceof Element ? o.appendChild(t) : "string" == typeof t ? o.innerHTML += t : t.final ? o.appendChild(t.final()) : n("尝试增加非法子节点"); return r }, append: function () { return document.body.appendChild(o), o }, modify: function (t) { return t(o), r }, final: function () { return o }, listen: function (t, e) { return o.addEventListener(t, e), r } }; return r } })();